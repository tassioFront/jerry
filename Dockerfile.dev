# Dev Dockerfile for FastAPI auth service
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Dev user (optional, keep same as prod for consistency)
RUN groupadd -r appuser && useradd -r -g appuser appuser

WORKDIR /app

# System deps
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Install base deps
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Install dev deps
COPY requirements-dev.txt .
RUN pip install --no-cache-dir -r requirements-dev.txt

# Copy entrypoint and necessary metadata (scripts, alembic, etc.)
COPY docker-entrypoint.sh .
COPY alembic.ini .
COPY migrations ./migrations

# For local dev we mount the source code as a volume,
# so no need to copy app/tests here (compose will bind-mount).

RUN chown -R appuser:appuser /app
RUN chmod +x /app/docker-entrypoint.sh

ARG USER_ID=1000
ARG GROUP_ID=1000

# Use adduser (handles existence, cleaner)
RUN groupadd -g ${GROUP_ID} -f appuser && \
    useradd -u ${USER_ID} -g ${GROUP_ID} -m -d /app -s /bin/sh appuser || \
    true


USER appuser

EXPOSE 8000

ENTRYPOINT ["/app/docker-entrypoint.sh"]
# docker-compose will override CMD per service:
# e.g.: api -> uvicorn main:app, test -> sh -c "alembic upgrade head && pytest -v"
CMD ["python", "-m", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8000", "--reload"]
